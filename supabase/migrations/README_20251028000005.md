# Migration 20251028000005 - Fix get_branch_data() RPC

## Quick Start (For The Person Applying This)

### Step 1: Pre-Flight Validation (5 minutes)
Run `PRE_FLIGHT_VALIDATION.sql` in Supabase SQL Editor and verify:
- ✅ Check 1: Returns 6 rows (crop fields exist)
- ✅ Check 2: Returns 1 row (version field exists)
- ✅ Check 3: Returns < 5 (low CASCADE impact)

**STOP if any check fails!**

### Step 2: Apply Migration via MCP
```bash
mcp__supabase__apply_migration({
  name: "fix_get_branch_data_restore_recursive_cte",
  query: <paste full SQL from 20251028000005_fix_get_branch_data_restore_recursive_cte.sql>
})
```

### Step 3: Test (10 minutes)
```sql
-- Test 1: Check signature
SELECT parameter_name FROM information_schema.parameters
WHERE routine_name = 'get_branch_data' AND parameter_mode = 'OUT';
-- Should show: original_photo_url, crop_metadata, crop_top/bottom/left/right, version

-- Test 2: Test query
SELECT id, crop_top, crop_bottom, version FROM get_branch_data(NULL, 1, 5);
-- Should return rows with all fields

-- Test 3: Performance
EXPLAIN ANALYZE SELECT * FROM get_branch_data('R1', 3, 100);
-- Should be < 500ms
```

### Step 4: Test in App
1. Restart app
2. Search for any profile → Tap "هذا أنا؟"
3. **Verify**: Branch tree modal opens (NO PGRST202 error)
4. **Verify**: Main tree loads correctly
5. **Verify**: Console shows version field: `useTreeStore.getState().treeData[0].version`

---

## What This Migration Fixes

### The Problem
Migration `20251027140400` deployed a **PLACEHOLDER stub** that changed the function signature:

**Old (working):**
```sql
get_branch_data(p_hid TEXT, p_max_depth INT, p_limit INT)
```

**New (broken):**
```sql
get_branch_data(p_target_id UUID, p_depth INT, p_limit INT)
```

**Result**: All 5 calling locations broke with error:
```
PGRST202: Could not find function get_branch_data(p_hid, p_limit, p_max_depth)
```

### The Solution
1. **Restore** working implementation from migration `20251026020000`
2. **Add 7 fields** to complete the crop migration intent:
   - original_photo_url TEXT
   - crop_metadata JSONB
   - crop_top/bottom/left/right NUMERIC(4,3)
   - version INT (CRITICAL for batch operations)
3. **Keep original signature** so all callers work without modification

---

## Affected Code (NO CHANGES NEEDED)

All 5 calling locations already use correct signature:

1. **BranchTreeProvider.js:48**
   ```javascript
   await supabase.rpc('get_branch_data', {
     p_hid: targetPersonId,
     p_max_depth: 3,
     p_limit: 20
   });
   ```

2. **profiles.js:12**
   ```javascript
   await supabase.rpc("get_branch_data", {
     p_hid: hid,
     p_max_depth: maxDepth,
     p_limit: limit,
   });
   ```

3. **useStore.js:27**
   ```javascript
   await profilesService.getBranchData(rootNode.hid, 10, 5000);
   ```

4. **useTreeDataLoader.js:157**
   ```javascript
   await profilesService.getBranchData(rootHid, 15, 5000);
   ```

5. **useFocusedTreeData.js:56,212**
   ```javascript
   await profilesService.getBranchData(focusPersonId, depth, limit);
   ```

**Zero frontend changes required! ✅**

---

## Success Criteria

After applying this migration, verify:

### Database Level
- ✅ Function signature is `get_branch_data(p_hid TEXT, p_max_depth INT, p_limit INT)`
- ✅ Returns TABLE has 50+ fields including crop fields and version
- ✅ No PGRST202 errors when calling function
- ✅ Performance < 500ms for typical queries

### App Level
- ✅ Branch tree modal loads without errors
- ✅ Main tree loads without errors
- ✅ Search → "هذا أنا؟" → Modal opens successfully
- ✅ Version field present in returned data
- ✅ Crop fields present in returned data

---

## Technical Details

### Pattern Used
This migration follows the **EXACT pattern** that successfully fixed `search_name_chain()` yesterday (migration `20251028000004`):

1. Restore last known working version
2. Add new fields to RETURNS TABLE
3. Add new fields to all SELECT statements (3 locations)
4. Keep original function signature
5. Validate post-migration

### Fields Added (7 total)

**Photo/Crop Group** (added after photo_url):
- `original_photo_url TEXT`
- `crop_metadata JSONB`
- `crop_top NUMERIC(4,3)`
- `crop_bottom NUMERIC(4,3)`
- `crop_left NUMERIC(4,3)`
- `crop_right NUMERIC(4,3)`

**Version Control** (added after updated_at):
- `version INT` ← **CRITICAL** for batch operations

### Modified Locations
The recursive CTE has 3 SELECT statements that all needed the 7 new fields:
1. Base case SELECT (lines ~90-135)
2. Recursive case SELECT (lines ~145-190)
3. Final SELECT (lines ~200-245)

---

## Rollback Plan

If this migration causes issues:

1. **Get current broken version** (if you didn't save it):
   ```sql
   SELECT pg_get_functiondef(oid) FROM pg_proc WHERE proname = 'get_branch_data';
   ```

2. **Restore it** (only if needed):
   ```sql
   -- Copy output from above and execute
   ```

---

## Timeline

| Task | Duration | Who |
|------|----------|-----|
| Pre-flight validation | 5 min | You (SQL Editor) |
| Apply migration | 2 min | You (MCP tool) |
| SQL tests | 5 min | You (SQL Editor) |
| App tests | 10 min | You (Test device) |
| **TOTAL** | **~20 min** | |

---

## Related Files

- **Migration**: `20251028000005_fix_get_branch_data_restore_recursive_cte.sql`
- **Validation**: `PRE_FLIGHT_VALIDATION.sql`
- **Source**: `20251026020000_fix_get_branch_data_bio_type.sql` (reference)
- **Broken**: `20251027140400_update_branch_search_rpcs_with_crop.sql` (caused issue)
- **Success**: `20251028000004_fix_search_name_chain_restore_recursive_cte.sql` (same pattern)

---

## Questions?

Contact Claude Code or check:
- CLAUDE.md (section: Database Migrations)
- docs/MIGRATION_GUIDE.md
- docs/FIELD_MAPPING.md

---

**Status**: Ready to apply (Plan-validator approved: 85% confidence, GO with modifications)
